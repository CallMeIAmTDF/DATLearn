<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link rel="stylesheet" href="./sign-in.css">
    <title>Quên mật khẩu</title>
    <script>
        const emailRegex = /^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+\.[a-zA-Z]{2,})$/i;
        const passwordRegex = /^.{8,20}$/i;
        accessToken = window.localStorage.getItem('accessToken')
        if (accessToken) window.location.href = '/'
    </script>
</head>

<body>
    <div id="snackbar">Some text some message..</div>
    <div class="container">
        <div class="signin-signup">
            <form class="sign-in-form">
                <h2 class="title">Quên Mật Khẩu</h2>
                <div class="input-field">
                    <i class="fas fa-user"></i>
                    <input type="text" placeholder="Email" id="forgetEmail">
                </div>
                <button type=submit class="btn" id="sendBtn">Gửi mã xác nhận</button>
                <!-- <input type=submit value="Gửi mã xác nhận" class="btn"> -->
            </form>
            <form class="sign-up-form">
                <h2 class="title">Xác Nhận Thông Tin</h2>
                <div class="otp-field" style="margin-top:1rem;margin-bottom:1rem;">
                    <input type="number" />
                    <input type="number" disabled />
                    <input type="number" disabled />
                    <input type="number" disabled />
                    <input type="number" disabled />
                    <input type="number" disabled />
                </div>
                <div class="input-field">
                    <i class="fas fa-lock"></i>
                    <input type="password" placeholder="Mật Khẩu Mới" id="password">
                </div>
                <button type="submit" class="btn" id="verifyBtn" style="margin-top:2rem;">Xác nhận</button>
                <!-- <input type="submit" value="VERIFY" class="btn" style="margin-top:2rem;"> -->
                <p class="resend text-muted mb-0">
                    Didn't receive code? <a href="">Request again</a>
                </p>
            </form>
        </div>
        <div class="panels-container">
            <div class="panel left-panel">
                <div class="content">
                    <img src="./assets/logo/DAT3.png" alt="DAT3" width="160" height="160">
                    <p></p>
                    <h4>Kiểm tra trình độ ngôn ngữ của bạn</h4>
                </div>
            </div>
            <div class="panel right-panel">
                <div class="content">
                    <img src="./assets/logo/DAT3.png" alt="DAT3" width="160" height="160">
                    <p></p>
                    <h4>Kiểm tra trình độ ngôn ngữ của bạn</h4>
                </div>
            </div>
        </div>
    </div>
    <script>
        async function postAPI(url) {
            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            return response.json()
        }
        async function postAPIWithBody(url, data) {
            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            return response.json()
        }
        function notice(body, url) {
            var notification = new Notification('DATLearn', {
                icon: './assets/icons/spelling-disable.svg',
                body: body,
            });
            if (url === undefined || url === null || url === '') url = '/'
            notification.onclick = function () {
                window.open(url);
            };
        }
        const container = document.querySelector(".container");

        //Gửi mã xác nhận
        document.getElementsByTagName('form')[0].addEventListener('submit', (e) => {
            e.preventDefault();
            document.getElementById('sendBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>'
            email = document.getElementById('forgetEmail').value;
            if (!emailRegex.test(email)) {
                var x = document.getElementById("snackbar");
                x.className = "show";
                x.innerText = `Bạn Phải Nhập Một Email`
                x.style.backgroundColor = '#ed5f5f'
                document.getElementById('sendBtn').innerHTML = 'Gửi mã xác nhận'
                setTimeout(function () { x.className = x.className.replace("show", ""); }, 1500);
            } else {
                postAPI(`http://localhost:8080/api/users/forgetPassword?email=${email}`).then(data => {
                    if (data.status === 'OK') {
                        notice(data.message, 'https://mail.google.com/mail/u/0/#inbox');
                        container.classList.add("sign-up-mode");
                    } else {
                        notice(data.message);
                    }
                    document.getElementById('sendBtn').innerHTML = 'Gửi mã xác nhận'
                })
            }
        });

        //Xác nhận OTP
        document.getElementsByTagName('form')[1].addEventListener('submit', (e) => {
            e.preventDefault();
            email = document.getElementById('forgetEmail').value;
            inp = document.querySelectorAll(".otp-field > input");
            password = document.getElementById('password').value;
            if (!passwordRegex.test(password)) {
                var x = document.getElementById("snackbar");
                x.className = "show";
                x.innerText = `Mật khẩu từ 8 - 20 ký tự`
                x.style.backgroundColor = '#ed5f5f'
                document.getElementById('verifyBtn').innerHTML = 'Xác nhận'
                setTimeout(function () { x.className = x.className.replace("show", ""); }, 1500);
            }
            else {
                let otp = '';
                for (let i = 0; i < inp.length; i++) {
                    otp += inp[i].value;
                }
                data = {
                    "password": password,
                    "email": email,
                    "otp": otp
                }
                postAPIWithBody('http://localhost:8080/api/users/forgetPassword/checkOtp', data).then(data => {
                    if (data.status === 'OK') {
                        alert('Thay đổi mật khẩu thành công.');
                        window.location.href = '/sign-in.html'
                    } else {
                        notice(data.message);
                        container.classList.add("sign-up-mode");
                    }
                })
            }

        });
        const inputs = document.querySelectorAll(".otp-field > input");
        const button = document.querySelectorAll(".btn")[1];

        window.addEventListener("load", () => inputs[0].focus());
        button.setAttribute("disabled", "disabled");

        inputs[0].addEventListener("paste", function (event) {
            event.preventDefault();

            const pastedValue = (event.clipboardData || window.clipboardData).getData(
                "text"
            );
            const otpLength = inputs.length;

            for (let i = 0; i < otpLength; i++) {
                if (i < pastedValue.length) {
                    inputs[i].value = pastedValue[i];
                    inputs[i].removeAttribute("disabled");
                    inputs[i].focus;
                } else {
                    inputs[i].value = ""; // Clear any remaining inputs
                    inputs[i].focus;
                }
            }
        });

        inputs.forEach((input, index1) => {
            input.addEventListener("keyup", (e) => {
                const currentInput = input;
                const nextInput = input.nextElementSibling;
                const prevInput = input.previousElementSibling;
                if (currentInput.value.length > 1) {
                    currentInput.value = "";
                    return;
                }
                if (
                    nextInput &&
                    nextInput.hasAttribute("disabled") &&
                    currentInput.value !== ""
                ) {
                    nextInput.removeAttribute("disabled");
                    nextInput.focus();
                }

                if (e.key === "Backspace") {
                    inputs.forEach((input, index2) => {
                        if (index1 <= index2 && prevInput) {
                            input.setAttribute("disabled", true);
                            input.value = "";
                            prevInput.focus();
                        }
                    });
                }

                button.classList.remove("active");
                button.setAttribute("disabled", "disabled");

                const inputsNo = inputs.length;
                if (!inputs[inputsNo - 1].disabled && inputs[inputsNo - 1].value !== "") {
                    button.classList.add("active");
                    button.removeAttribute("disabled");

                    return;
                }
            });
        });

    </script>
</body>

</html>